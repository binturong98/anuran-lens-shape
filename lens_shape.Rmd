---
title: "Analyses for: Lens morphology is influenced by ecology in frogs and toads"
authors: "A.T. Mitra, K.N. Thomas, M.C. Womack"
date: "28 Oct 2021"
output:
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    code_fold: hide
    
---

```{r setup, include = FALSE}

# Markdown settings
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 6, fig.width = 8, attr.output='style="max-height: 400px;"') 

# Load packages
library(cowplot)
library(tcltk)
library(ape)
library(phytools)
library(geiger)
library(stringr)
library(kableExtra)
library(plotly)
library(geomorph)
library(RRPP)
library(viridis)
library(pca3d)
library(gridExtra)
library(caper)
library(tidyverse)
```

# Data and subsetting

## Raw data

The raw data file contains one row for **each lens** sampled. For most specimens, there are two rows of data: one for the right lens and one for the left lens. However, for a few specimens, we repeated measurements on the lenses independently to quantify error, and these are included as separate rows. The raw data file also includes measurements from four artificial objects created in Blender for reference measurements. These are all coded as life stage "artificial", and can be removed or extracted that way. The phylogeny data is the consensus tree from Jetz and Pyron (2019).

```{r raw-data}

# Load raw data
lens_data <- read.csv("ct_lenses.csv", header = TRUE, na.strings=c("", "NA", " "))

#Import phylogeny from Jetz and Pyron 2019
tree_orig <- read.tree(file = "amph_shl_new_Consensus_7238.tre") #reads tree
```

## Tidy up data

Here, we tidy up a few messy things. For activity period, cathemeral is changed to "both" to mirror the paper, empty ecological fields (or those termed "unknown") are changed to NA. Unused fields (e.g. alternate coding for adult habitat, lens measurements not analyzed, etc.) are removed. When we publish final version, we should download and include this tidied datasheet instead of the raw one. 

```{r}
lens_data_tidy <- lens_data %>%
  #capitalize order
  mutate(order = str_to_title(order)) %>%
  #capitalize family
  mutate(family = str_to_title(family)) %>%
  #capitalize genus
  mutate(genus = str_to_title(genus)) %>%
  #change activity period from cathemeral to both
  mutate(activity_period = recode(activity_period, "cathemeral" = "both")) %>%
  #change unknown activity period to NA
  mutate(activity_period = na_if(activity_period, "unknown")) %>%
  #change unknown adult habitat to NA
  mutate(adult_ecology = na_if(adult_ecology, "unknown")) %>%
  #select only used columns of data
  select(specimen_id, order, family, genus, species, life_stage, lens, flatness, anisotropy, elongation, sphericity, eye_diameter_mm, lens_diameter_mm,  sv_length_mm, stain, scan_type, adult_ecology, ae_source, activity_period, ap_source, comments, scan_source, scan_technician)
```


## Mean lens shape by specimen

The following subset includes one row for **each specimen** measured. We created this subset by removing repeated measurements of the same lens, and then calculating the mean of the left and right lens for each specimen. This subset also includes artificial reference blender shapes. 

```{r specimen-means}

#Calculate mean lens parameters for each specimen
specimen_means <- lens_data_tidy %>%
  mutate(genus_species = as.factor(paste(genus, species, sep = "_"))) %>% # creates a genus_species column
  filter(life_stage != "repeat") %>%
  mutate_if(is.character, as.factor) %>% 
  group_by(specimen_id, genus_species, family, life_stage, adult_ecology, activity_period, scan_source, stain) %>%
  summarise(mean_flatness = mean(flatness, na.rm = TRUE),
            mean_anisotropy = mean(anisotropy, na.rm = TRUE),
            mean_elongation = mean(elongation, na.rm = TRUE),
            mean_sphericity = mean(sphericity, na.rm = TRUE),
            mean_svl = mean(sv_length_mm, na.rm = TRUE),
            n = n()) %>%
  ungroup() 

#convert NaN values to NA 
specimen_means[specimen_means == "NaN"] <- NA

```

Here, we report summary data on specimen sampling (after removing the 4 artificial reference objects created in Blender). Note that the specimen ID "MS2_top" refers to both a tadpole and an adult specimen, and is a duplicated element (thus there is one less factor level for specimen ID than there are actual unique specimens).

```{r}
#remove artificial objects from dataset
specimen_means2 <- specimen_means %>%
  filter(life_stage != "artificial") %>%
  droplevels()

#save data on sampling
n_specimen <- nrow(specimen_means2) #total number of specimens sampled
n_adult_specimens <- nrow(specimen_means2 %>% filter(life_stage=="adult"))
n_tad_specimens <- nrow(specimen_means2 %>% filter(life_stage=="tadpole"))
n_family <- length(levels(specimen_means2$family))
n_species <- length(levels(specimen_means2$genus_species))
```

Number of specimens sampled total: `r n_specimen`
Number of adult specimens sampled: `r n_adult_specimens`
Number of tadpole specimens sampled: `r n_tad_specimens`
Number of families sampled: `r n_family`
Number of species sampled: `r n_species`

Number of specimens sampled by source: 

```{r}
#number of specimens by source
specimen_means2 %>%
  group_by(life_stage) %>%
  count(scan_source)
```
Number of specimens sampled by staining:

```{r}
#number of specimens by source
specimen_means2 %>%
  group_by(life_stage) %>%
  count(stain)
```

## Mean lens shape by species and life stage

The following creates a dataframe with **one row per life stage for a species**. Mean shape data for **tadpoles** and for **adults** are in separate rows and any duplicated life stages within species are averaged. This subset contains anurans only (no artificial reference shapes).

```{r species-stage-means}

species_stage_means <- specimen_means %>%
  filter(life_stage != "artificial") %>%
  group_by(genus_species, family, life_stage, adult_ecology, activity_period) %>%
  summarise(mean_flatness = mean(mean_flatness, na.rm = TRUE),
            mean_anisotropy = mean(mean_anisotropy, na.rm = TRUE),
            mean_elongation = mean(mean_elongation, na.rm = TRUE),
            mean_sphericity = mean(mean_sphericity, na.rm = TRUE),
            mean_svl = mean(mean_svl, na.rm = TRUE),
            n_specimens = n())

#add synonym and substitutions for phylogeny into dataframe (genus_species column)
species_stage_means$genus_species <- as.character(species_stage_means$genus_species)
species_stage_means[species_stage_means$genus_species=="Hypsiboas_geographica", "genus_species"] <- "Hypsiboas_geographicus"
species_stage_means[species_stage_means$genus_species=="Chiasmocleis_hudsoni", "genus_species"] <- "Syncope_hudsoni"
species_stage_means[species_stage_means$genus_species=="Rhombophryne_nilevina", "genus_species"] <- "Rhombophryne_alluaudi"
```

The following creates a dataframe with **one row per species**

```{r species_means-wide}

#make separate dataframes for adults and tadpoles
tads_mean <- filter(species_stage_means, life_stage == "tadpole") %>% droplevels()
adults_mean <- filter(species_stage_means, life_stage == "adult") %>% droplevels()

#merge tadpole and adult dataframes by species (all data)
species_means <- full_join(tads_mean, adults_mean, 
                           by = "genus_species", 
                           suffix = c(".tads", ".adults"))

#merge only matched tadpole and adult data within species
species_matched <- inner_join(tads_mean, adults_mean,
                              by = c("genus_species", "family"),
                           suffix = c(".tads", ".adults")) %>% droplevels()

#sampling for adults and tadpoles
n_tadpole_species <- length(levels(tads_mean$genus_species))
n_adult_species <- length(levels(adults_mean$genus_species))
n_matched_species <- length(levels(species_matched$genus_species))
n_matched_families <- length(levels(species_matched$family))
```

Species sampling by life stage:

Number of species with adult data: `r n_adult_species`

Number of species with tadpole data: `r n_tadpole_species`

Number of species with both tadpole and adult data (matched): `r n_matched_species`

## Species with eye size data

This dataframe pulls out the specimens that we were able to get 2D eye size measurements for in Avizo. These were mostly adults, but did include a few tadpoles. The mean eye measurements are calculated for each **specimen**. Then, since there were few tadpoles with data, the **adults** are subset out for further analyses. 

```{r subsets for eye data in anura only - activity and ecology}

#create dataframe for eye subset
eye_mean <- lens_data_tidy %>%
  mutate(genus_species = as.factor(paste(genus, species, sep = "_"))) %>% 
  mutate_if(is.character, as.factor) %>% 
  filter(life_stage == c("adult", "tadpole"))  %>% 
  group_by(genus_species, life_stage, adult_ecology, activity_period) %>%
  summarise(mean.eye.diameter = mean(eye_diameter_mm, na.rm = TRUE),
            mean.lens.diameter = mean(lens_diameter_mm, na.rm = TRUE),
            n = n())

#convert NaN values to NA 
eye_mean[eye_mean == "NaN"] <- NA

# subsetting for adults 
adult_eye <- eye_mean %>%
  filter(life_stage != "artificial" & life_stage != "outgroup" & life_stage != "tadpole") %>%
  mutate(lens_relative_to_eye = mean.lens.diameter/mean.eye.diameter) %>%
  filter(lens_relative_to_eye > 0)

#capitalize genus 
str_sub(adult_eye$genus_species, 1, 1) <- str_sub(adult_eye$genus_species, 1, 1) %>% str_to_upper()

#add synonym and substitutions for phylogeny into dataframe (lens_species column)
adult_eye[adult_eye$genus_species=="Hypsiboas_geographica", "genus_species"] <- "Hypsiboas_geographicus"
adult_eye[adult_eye$genus_species=="Chiasmocleis_hudsoni", "genus_species"] <- "Syncope_hudsoni"
adult_eye[adult_eye$genus_species=="Rhombophryne_nilevina", "genus_species"] <- "Rhombophryne_alluaudi"
```

Species with 2D adult eye & lens size data:  `r nrow(adult_eye)`


# Data checks

## Repeat measurements

The following dataframe subsets the specimens and lenses that were measured multiple times independently in order to determine the precision of measurement techniques. 

```{r subset to dataframe for repeat measures}

lens_repeat <- lens_data_tidy %>%
  filter(life_stage == "repeat" & specimen_id != "USNM299711")
  
```

## Coefficient of variation

The coefficient of variation (CV) is the ratio of the standard deviation to the mean. The higher the coefficient of variation, the greater the level of dispersion around the mean. Here, we compare the coefficients of variation for repeat measures within one specimen to the coefficients of variation across the full dataset. 

``` {r calculating cv}

lens_repeat %>%
  group_by(specimen_id) %>%
  summarise(coef.var.flat = (sd(flatness)/mean(flatness))*100,
            coef.var.aniso = (sd(anisotropy)/mean(anisotropy))*100,
            coef.var.spher = (sd(sphericity)/mean(sphericity))*100,
            coef.var.elong = (sd(elongation)/mean(elongation))*100)

# The coefficients of variation for all the measures are quite low < 10 %

# CVs calculated for the entire dataset show much higer variation so it is okay to use this method 
species_stage_means %>%
  group_by()%>%
  summarise(coef.var.flat = (sd(mean_flatness)/mean(mean_flatness))*100,
            coef.var.aniso = (sd(mean_anisotropy)/mean(mean_anisotropy))*100,
            coef.var.spher = (sd(mean_sphericity)/mean(mean_sphericity))*100,
            coef.var.elong = (sd(mean_elongation)/mean(mean_elongation))*100)

```

## Left lens vs. right lens

The following creates a dataframe with **one row per specimen**. Shape data for **each lens** are in **separate columns**. The dataframe is then split into two: one for left lenses and one for right lenses. These dataframes contain data for anurans only.

```{r left-right-wide}

# dataframe that averages by specimen
LR_lens_data <- lens_data_tidy %>%
  mutate(genus_species = as.factor(paste(genus, species, sep = "_"))) %>% # creates a genus_species column
  filter(life_stage != "repeat" & specimen_id != "BMNH1906.8.30.62" & life_stage != "artificial") %>%
  mutate_if(is.character, as.factor) %>% 
  group_by(specimen_id, genus_species, lens, life_stage, adult_ecology, activity_period) %>%
  summarise(mean_flatness = mean(flatness, na.rm = TRUE),
            mean_anisotropy = mean(anisotropy, na.rm = TRUE),
            mean_elongation = mean(elongation, na.rm = TRUE),
            mean_sphericity = mean(sphericity, na.rm = TRUE),
            mean_svl = mean(sv_length_mm, na.rm = TRUE),
            n = n()) %>%
  ungroup() 

#subset left and right data  then merge left and right by specimen
#arrange(LR_lens_data, specimen_id, genus_species, life_stage)

L_lens_data <- filter(LR_lens_data, lens == "left")
R_lens_data <- filter(LR_lens_data, lens == "right")

LR_lens_data <- full_join(L_lens_data, R_lens_data, 
                          by = c("specimen_id", "life_stage"),
                          suffix = c(".left", ".right"))

LR_lens_data<-as.data.frame(LR_lens_data)
row.names(LR_lens_data)<-paste(LR_lens_data$specimen_id,row.names(LR_lens_data),sep="_")

#remove any rows with missing left or right lens shape data
LR_lens_data <- filter(LR_lens_data, mean_flatness.left > 0 & mean_anisotropy.left > 0 & mean_elongation.left > 0 & mean_sphericity.left > 0)
LR_lens_data <- filter(LR_lens_data, mean_flatness.right > 0 & mean_anisotropy.right > 0 & mean_elongation.right > 0 & mean_sphericity.right > 0)

```

Next, we plot data for left lens against right lens for all 3D shape metrics

```{r left vs right lens shape}

# left v right for individual metrics

#create plots
flat_lr_plot <- ggplot(LR_lens_data, aes(y=mean_flatness.left, x=mean_flatness.right)) +
  geom_point(alpha = 0.7) +
  theme_classic() +
  ylab("Left lens flatness") +
  xlab("Right lens flatness") +
  geom_smooth(method = "lm")

anis_lr_plot <- ggplot(LR_lens_data, aes(y=mean_anisotropy.left, x=mean_anisotropy.right)) +
  geom_point(alpha = 0.7) +
  theme_classic() +
  ylab("Left lens anisotropy") +
  xlab("Right lens anisotropy") +
  geom_smooth(method = "lm")
  
elong_lr_plot <- ggplot(LR_lens_data, aes(y=mean_elongation.left, x=mean_elongation.right)) +
  geom_point(alpha = 0.7) +
  theme_classic() +
  ylab("Left lens elongation") +
  xlab("Right lens elongation") +
  geom_smooth(method = "lm")

spher_lr_plot <- ggplot(LR_lens_data, aes(y=mean_sphericity.left, x=mean_sphericity.right)) +
  geom_point(alpha = 0.7) +
  theme_classic() +
  ylab("Left lens sphericity") +
  xlab("Right lens sphericity") +
  geom_smooth(method = "lm")

#make figure
plot <- plot_grid(anis_lr_plot, flat_lr_plot, spher_lr_plot, elong_lr_plot,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A","B","C","D"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 2) #number of rows in grids

#print figure
plot
```
```{r, results="hide"}
#export figure
pdf(file = "Figures/Fig-supp-LR_lens_shape.pdf", width = 9,  height = 7)
plot
dev.off()
```


```{r}
# linear models of left vs right values for each lens metric
LR_flat<-lm(LR_lens_data$mean_flatness.left~LR_lens_data$mean_flatness.right)
LR_anis<-lm(LR_lens_data$mean_anisotropy.left~LR_lens_data$mean_anisotropy.right)
LR_elon<-lm(LR_lens_data$mean_elongation.left~LR_lens_data$mean_elongation.right)
LR_sphe<-lm(LR_lens_data$mean_sphericity.left~LR_lens_data$mean_sphericity.right)

#summary of each model
summary(LR_flat)
summary(LR_anis)
summary(LR_elon)
summary(LR_sphe)
```

We also examine model residuals from these regressions. 

```{r}

# naming the residuals of the models as specimen_id
names(LR_flat$residuals)<-LR_lens_data$specimen_id
names(LR_anis$residuals)<-LR_lens_data$specimen_id
names(LR_elon$residuals)<-LR_lens_data$specimen_id
names(LR_sphe$residuals)<-LR_lens_data$specimen_id

#plot ordered residuals

#pdf(file = "LeftVsRight_LensShape_OrderedLMResiduals_.pdf", width = 9,  height = 7)
par(mfrow=c(2, 2))

LR_flat$residuals <- sort(-(LR_flat$residuals))
plot(LR_flat$residuals)
abline(0,0, col="red")

LR_anis$residuals <- sort(-(LR_anis$residuals))
plot(LR_anis$residuals)
abline(0,0, col="red")

LR_elon$residuals <- sort(-(LR_elon$residuals))
plot(LR_elon$residuals)
abline(0,0, col="red")

LR_sphe$residuals <- sort(-(LR_sphe$residuals))
plot(LR_sphe$residuals)
abline(0,0, col="red")
#dev.off()

#plot ordered residuals with specimen labels
pdf(file = "LeftVsRight_LensShape_OrderedLMResiduals_Labeled_.pdf", width = 30,  height = 30)
par(mfrow=c(2, 2))
plot(LR_flat$residuals)
text(LR_flat$residuals, label=names(LR_anis$residuals))
plot(LR_anis$residuals)
text(LR_anis$residuals, label=names(LR_anis$residual))
plot(LR_elon$residuals)
text(LR_elon$residuals, label=names(LR_elon$residual))
plot(LR_sphe$residuals)
text(LR_sphe$residuals, label=names(LR_sphe$residual))
dev.off()

# Start writing to an output file
sink('LR_ShapeAssymetry_Outliers.txt')

#check for outliers
cat("\n\n LR_Flat_Outliers \n")
boxplot.stats(LR_flat$residuals)$out  
cat("\n\n LR_Anis_Outliers \n")
boxplot.stats(LR_anis$residuals)$out  
cat("\n\n LR_Elon_Outliers \n")
boxplot.stats(LR_elon$residuals)$out 
cat("\n\n LR_Sphe_Outliers \n")
boxplot.stats(LR_sphe$residuals)$out  

# Stop writing to the file
sink()

```

## Tests for correlation between 3D shape metrics

Correlation between all metrics. Flatness is excluded from further analyses to avoid multicollinearity because it is highly correlated with anisotropy 

```{r correlation in lens metrics}

#linear regressions and plots of pairs of shape metrics

#flatness vs. anisotropy
flat_anis <- ggplot(species_stage_means, aes(x = mean_anisotropy, y = mean_flatness, shape = life_stage)) +
  scale_shape_manual(values=c(19,1), name = "Life stage") +
  geom_point(alpha = 0.6) +
  theme_classic() +
  labs(x="Anisotropy", y="Flatness") +
  theme(legend.position = "none")

summary(lm(mean_flatness~mean_anisotropy, data = species_stage_means))


#flatness vs. elongation 
flat_elon <- ggplot(species_stage_means, aes(x = mean_elongation, y = mean_flatness, shape = life_stage)) +
  scale_shape_manual(values=c(19,1), name = "Life stage") +
  geom_point(alpha = 0.6) +
  theme_classic() +
  labs(x="Elongation", y="Flatness") +
  theme(legend.position = "none")

summary(lm(mean_flatness~mean_elongation, data = species_stage_means))


#flatness vs. sphericity
flat_sph <- ggplot(species_stage_means, aes(x = mean_sphericity, y = mean_flatness, shape = life_stage)) +
  scale_shape_manual(values=c(19,1), name = "Life stage") +
  geom_point(alpha = 0.6) +
  theme_classic() +
  labs(x="Sphericity", y="Flatness") +
  theme(legend.position = "none")

summary(lm(mean_flatness~mean_sphericity, data = species_stage_means))

#elongation vs. anisotropy
elong_anis <- ggplot(species_stage_means, aes(x = mean_anisotropy, y = mean_elongation, shape = life_stage)) +
  scale_shape_manual(values=c(19,1), name = "Life stage") +
  geom_point(alpha = 0.6) +
  theme_classic() +
  labs(x="Anisotropy", y="Elongation") +
  theme(legend.position = "none")

summary(lm(mean_elongation~mean_anisotropy, data = species_stage_means))


#elongation vs. sphericity
elong_sph <- ggplot(species_stage_means, aes(x = mean_sphericity, y = mean_elongation, shape = life_stage)) +
  scale_shape_manual(values=c(19,1), name = "Life stage") +
  geom_point(alpha = 0.6) +
  theme_classic() +
  labs(x="Sphericity", y="Elongation") +
  theme(legend.position = "none")

summary(lm(mean_elongation~mean_sphericity, data = species_stage_means))


#sphericity vs. anisotropy
sph_anis <- ggplot(species_stage_means, aes(x = mean_anisotropy, y = mean_sphericity, shape = life_stage)) +
  scale_shape_manual(values=c(19,1), name = "Life stage") +
  geom_point(alpha = 0.6) +
  theme_classic() +
  labs(x="Anisotropy", y="Sphericity") +
  theme(legend.position = "none")

summary(lm(mean_sphericity~mean_anisotropy, data = species_stage_means))

#construct supplemental figure
plots <- plot_grid(flat_anis, flat_elon, flat_sph, elong_anis, elong_sph, sph_anis,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A","B","C","D","E","F"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 3) #number of rows in grids

#print figure
plots

#export figure
pdf(file = "Figures/Fig-supp_shape_correlations.pdf", width = 10,  height = 12)
plots
dev.off()
```

## Tests for correlation between lens shape and body size

We checked that among adults that we had body size (snout-vent length) data for, there was no correlation between body size and any of the 3D shape metrics, as this could influence our models and interpretations. 


```{r snout-vent length and shape}

#regressions of lens shape vs. SVL 
summary(lm(mean_sphericity~mean_svl, data = species_stage_means))
summary(lm(mean_anisotropy~mean_svl, data = species_stage_means))
summary(lm(mean_flatness~mean_svl, data = species_stage_means))
summary(lm(mean_elongation~mean_svl, data = species_stage_means))

#plots of lens shape by body size
par(mfrow=c(2, 2))
plot(mean_sphericity~mean_svl, data = species_stage_means)
plot(mean_anisotropy~mean_svl, data = species_stage_means)
plot(mean_flatness~mean_svl, data = species_stage_means)
plot(mean_elongation~mean_svl, data = species_stage_means)

#plot of mean body size across adult habitats
par(mfrow=c(1, 1))
plot(mean_svl~adult_ecology, data = species_stage_means)

```

# Data Analysis      

## Q1 Lens shape of tadpoles vs. adults

Here, we examine whether tadpole lens shape differs from adult lens shape across all species sampled (118 species with adult data, 48 species with tadpole data). These models do not include phylogenetic corrections. 

### Principle component analysis

```{r PCA}

#dimension conversion
row.names(species_stage_means) <- paste(species_stage_means$life_stage, row.names(species_stage_means), sep="_") 
species_stage_means$life_Stage <- NULL

# running PCA on tadpoles and adults with anisotropy, elongation and sphericity values
lens.pca <- prcomp(species_stage_means[,c("mean_anisotropy","mean_elongation","mean_sphericity")], center = TRUE, scale. = TRUE)

# summary stats
summary(lens.pca)

str(lens.pca)

# eigenvectors
lens.pca$rotation

# eigenvalues 
(lens.pca$sdev)^2

# plot directly
plot(lens.pca$x[,1], lens.pca$x[,2])
```


### t-tests 

Here, we use Welch's two-sample t tests to test whether tadpoles and adults exhibit different lens shapes for each of the three shape metrics examined (anisotropy, sphericity, and elongation).

```{r independent t-test all tads and adults}

# unequal variances therefore welch two sample t-test 

#anisotropy
t.test(mean_anisotropy~life_stage, data = species_stage_means)

#sphericity
t.test(mean_sphericity~life_stage, data = species_stage_means)

#elongation
t.test(mean_elongation~life_stage, data = species_stage_means)
```

### Procrustes MANOVA for shape variables

Here, we use a multivariate approach to test whether the three shape metrics together (sphericity, anisotropy, elongation) are associated with life stage (tadpole vs. adult)

```{r procD all metrics}

fit <- summary(procD.lm(species_stage_means[,c("mean_anisotropy","mean_elongation","mean_sphericity")]~life_stage,iter = 999,seed = NULL,RRPP = TRUE, SS.type = NULL, int.first = FALSE, Cov = NULL, data = species_stage_means, print.progress = TRUE)) 

fit

```

## Q2 Differences in lens shape through ontogeny within species

Here, we examine a subset of species (n = 44) that have matched tadpole and adult lens shape data to see how lens shape changes through ontogeny and whether this is driven by differences in adult habitat. 

### Phylogenetic signal

Here, we estimated phylogenetic signal in tadpole lens shape, in adult lens shape, and in the change in lens shape through ontogeny (difference between adults and tadpoles within species). For these analyses, we used the physignal function in the geomorph package, which estimates the multivariate version of the K-statistic (Kmult; Adams 2014) and allowed us to incorporate all three shape metrics (anisotropy, sphericity, elongation) simultaneously. 

```{r phylogenetic signal}

#Prepare data -----

# PCA with all data tadpole Xs and adults Os
pca_data <- cbind(as.data.frame(species_stage_means), as.data.frame(lens.pca$x))

pca_means <- pca_data %>%
  #mutate_if(is.character, as.factor) %>% 
  group_by(genus_species, life_stage, adult_ecology, activity_period) %>%
  summarise(mean_flatness = mean(mean_flatness, na.rm = TRUE),
            mean_anisotropy = mean(mean_anisotropy, na.rm = TRUE),
            mean_elongation = mean(mean_elongation, na.rm = TRUE),
            mean_sphericity = mean(mean_sphericity, na.rm = TRUE),
            mean_svl = mean(mean_svl, na.rm = TRUE),
            n = n(),
            mean_PC1 = mean(PC1, na.rm = TRUE),
            mean_PC2 = mean(PC2, na.rm = TRUE),
            mean_PC3 = mean(PC3, na.rm = TRUE)) %>%
  ungroup() 

#make separate dataframes for adults and tadpoles
phylo_tads <- filter(pca_means, life_stage == "tadpole")
phylo_adults <- filter(pca_means, life_stage == "adult")

#Merge dataset by genus species
phylo_pca_means <- full_join(phylo_tads, phylo_adults, 
                             by = "genus_species", 
                             suffix = c(".tads", ".adults"))

#capitalize genus 
str_sub(phylo_pca_means$genus_species, 1, 1) <- str_sub(phylo_pca_means$genus_species, 1, 1) %>% str_to_upper()

#add synonym and substitutions for phylogeny into dataframe
phylo_pca_means[phylo_pca_means$genus_species=="Hypsiboas_geographica", "genus_species"] <- "Hypsiboas_geographicus"
phylo_pca_means[phylo_pca_means$genus_species=="Chiasmocleis_hudsoni", "genus_species"] <- "Syncope_hudsoni"
phylo_pca_means[phylo_pca_means$genus_species=="Rhombophryne_nilevina", "genus_species"] <- "Rhombophryne_alluaudi"

#make a dataframe for matching with phylogeny 
phylo_pca_means<-as.data.frame(phylo_pca_means)

#Prepare trees -----

#trim tree to data
rownames(phylo_pca_means)<-phylo_pca_means$genus_species;
name.check(tree_orig,phylo_pca_means)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.pruned;
#plot(tree.pruned)

#Remove excess data from species not found in tree
phylo_pca_means<-phylo_pca_means[ ! phylo_pca_means$genus_species %in% overlap$data_not_tree, ]
phylo_pca_means[] <- lapply(phylo_pca_means, function(x) if(is.factor(x)) factor(x) else x)


#BUILD TAPDOLE, ADULT, & BOTH PHYLOGENETIC DATASETS
tad_phylo_means<-filter(phylo_pca_means , mean_flatness.tads > 0)

adult_phylo_means<-filter(phylo_pca_means , mean_flatness.adults > 0)

both_phylo_means<-filter(tad_phylo_means , mean_flatness.adults > 0)
both_phylo_means$mean_flatness.diff<-both_phylo_means$mean_flatness.tads-both_phylo_means$mean_flatness.adults
both_phylo_means$mean_anisotropy.diff<-both_phylo_means$mean_anisotropy.tads-both_phylo_means$mean_anisotropy.adults
both_phylo_means$mean_elongation.diff<-both_phylo_means$mean_elongation.tads-both_phylo_means$mean_elongation.adults
both_phylo_means$mean_sphericity.diff<-both_phylo_means$mean_sphericity.tads-both_phylo_means$mean_sphericity.adults

#trim tree to tad data
rownames(tad_phylo_means)<-tad_phylo_means$genus_species;
name.check(tree_orig,tad_phylo_means)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.tad;
#plot(tree.tad)

#Remove excess data from species not found in tree
tad_phylo_means<-tad_phylo_means[ ! tad_phylo_means$genus_species %in% overlap$data_not_tree, ]
tad_phylo_means[] <- lapply(tad_phylo_means, function(x) if(is.factor(x)) factor(x) else x)
rownames(tad_phylo_means)<-tad_phylo_means$genus_species;
tad_phylo_means <- tad_phylo_means[tree.tad$tip.label,]

#trim tree to adult data
rownames(adult_phylo_means)<-adult_phylo_means$genus_species;
name.check(tree_orig,adult_phylo_means)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.adult;
#plot(tree.adult)

#Remove excess data from species not found in tree
adult_phylo_means<-adult_phylo_means[ ! adult_phylo_means$genus_species %in% overlap$data_not_tree, ]
adult_phylo_means[] <- lapply(adult_phylo_means, function(x) if(is.factor(x)) factor(x) else x)
rownames(adult_phylo_means)<-adult_phylo_means$genus_species;
adult_phylo_means <-  adult_phylo_means[tree.adult$tip.label, ]

#trim tree to matched tad and adult (both) data
rownames(both_phylo_means)<-both_phylo_means$genus_species;
name.check(tree_orig,both_phylo_means)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.both;
#plot(tree.both)

#Remove excess data from species not found in tree
both_phylo_means<-both_phylo_means[ ! both_phylo_means$genus_species %in% overlap$data_not_tree, ]
both_phylo_means[] <- lapply(both_phylo_means, function(x) if(is.factor(x)) factor(x) else x)
rownames(both_phylo_means)<-both_phylo_means$genus_species;
both_phylo_means <-  both_phylo_means[tree.both$tip.label, ]

# Tests for phylogenetic signal ------

#phylogenetic signal of tadpole lens shape (all species of tads, n=48)
physignal(as.matrix(tad_phylo_means[,c(c("mean_anisotropy.tads","mean_elongation.tads","mean_sphericity.tads"))]), tree.tad,iter = 999, seed = NULL)

#phylogenetic signal of adult lens shape (all species of adults, n=118)
physignal(as.matrix(adult_phylo_means[,c("mean_anisotropy.adults","mean_elongation.adults","mean_sphericity.adults")]), tree.adult, iter = 999, seed = NULL)

#phylogenetic signal of the difference between tad and adult lens shape (n=44 species)
physignal(as.matrix(both_phylo_means[,c("mean_anisotropy.diff","mean_elongation.diff","mean_sphericity.diff")]), tree.both, iter = 999, seed = NULL)

#check phy signal for tadpoles in matched species only (n=44 species)
physignal(as.matrix(both_phylo_means[,c("mean_anisotropy.tads","mean_elongation.tads","mean_sphericity.tads")]), tree.both, iter = 999, seed = NULL)

#check phy signal for adults in matched species only (n=44 species)
physignal(as.matrix(both_phylo_means[,c("mean_anisotropy.adults","mean_elongation.adults","mean_sphericity.adults")]), tree.both, iter = 999, seed = NULL)

```

### Difference between tadpole and adult lens shape vs ecology

Here, we examine whether the change in lens shape through ontogeny (difference between tadpole and adult lens shape within species) differs across species that remain aquatic vs. transition to terrestrial environments. We do this first by examining each 3D lens metric individually, and then with a multivariate approach. 

#### PGLS 

```{r}

#pgls regressions testing for effect of adult habitat on each 3D shape metric (separately)

#prep data/tree ----

#add aquatic vs. terrestrial category
both_phylo_means$env <- ifelse(both_phylo_means$adult_ecology.adults=="aquatic", "aquatic", "terrestrial")

#align data and phylogeny labels
both_phylo_means <-  both_phylo_means[tree.both$tip.label, ] 

#label tree nodes
geocapertree <- makeNodeLabel(tree.both, method = "number", prefix = "Node")

#make comparative object
geocaperdata <- comparative.data(phy=geocapertree, data=both_phylo_means, names.col=genus_species, vcv=TRUE, na.omit=FALSE, warn.dropped=TRUE)

#pgls for anisotropy----

#fit model
aniso.pgls <- pgls(mean_anisotropy.diff~env, data=geocaperdata, lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(aniso.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(aniso.pgls)

#view coefficients
summary(aniso.pgls)


#pgls for sphericity----

#fit model
sphere.pgls <- pgls(mean_sphericity.diff~env, data=geocaperdata, lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(sphere.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(sphere.pgls)

#view coefficients
summary(sphere.pgls)

#pgls for elongation----

#fit model
elong.pgls<-pgls(mean_elongation.diff~env,data=geocaperdata, lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(elong.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(elong.pgls)

#view coefficients
summary(elong.pgls)
```

#### Procrustes MANOVA

```{r}

#check adequate levels for testing
table(both_phylo_means$env)

#procD.pgls of lens shape differences in all 3 measures 
procD<-procD.pgls(both_phylo_means[,c("mean_anisotropy.diff","mean_elongation.diff","mean_sphericity.diff")]~env, tree.both, Cov = NULL, iter = 999,seed = NULL, int.first = FALSE, SS.type = NULL, effect.type = NULL, data = both_phylo_means, print.progress = TRUE)
summary(procD)
```

## Q3 Adult lens shape and size vs ecology

Here, we examine whether adult lens size (relative to eye size) or shape are correlated with adult ecology (habitat or activity period). We do this across all adults sampled with available data (n = 181 species, with n=80 for eye size data)

### PGLS: Adult lens shape vs. ecology for each 3D shape metric

Here, we run a series of PGLS regressions to test for associations between each 3D shape metric (anisotropy, elongation, and sphericity) and adult ecology (habitat and activity period). 

#### Habitat

```{r}
#pgls regressions testing for effect of adult habitat on each 3D shape metric (separately)

#prep data and tree----

#subset adults with habitat data
adult_phylo_eco<-filter(adult_phylo_means, !is.na(adult_ecology.adults))
table(adult_phylo_eco$adult_ecology.adults)

#trim tree to adults with habitat data
rownames(adult_phylo_eco)<-adult_phylo_eco$genus_species;
name.check(tree_orig,adult_phylo_eco)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.adult.eco;
#plot(tree.adult.eco)

#Remove excess data from species not found in tree
adult_phylo_eco<-adult_phylo_eco[ ! adult_phylo_eco$genus_species %in% overlap$data_not_tree, ]
adult_phylo_eco[] <- lapply(adult_phylo_eco, function(x) if(is.factor(x)) factor(x) else x)
adult_phylo_eco <-  adult_phylo_eco[tree.adult.eco$tip.label, ]

#make comparative object
adult.eco.comp <- comparative.data(phy=tree.adult.eco, data=adult_phylo_eco, names.col=genus_species, vcv=TRUE, na.omit=FALSE, warn.dropped=TRUE)

#pgls for anisotropy----

#fit model
eco.aniso.pgls <- pgls(mean_anisotropy.adults ~ adult_ecology.adults,
                       data = adult.eco.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(eco.aniso.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(eco.aniso.pgls)

#view coefficients
summary(eco.aniso.pgls)

#pgls for sphericity----

#fit model
eco.sph.pgls <- pgls(mean_sphericity.adults ~ adult_ecology.adults,
                       data = adult.eco.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(eco.sph.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(eco.sph.pgls)

#view coefficients
summary(eco.sph.pgls)

#pgls for elongation----

#fit model
eco.elong.pgls <- pgls(mean_elongation.adults ~ adult_ecology.adults,
                       data = adult.eco.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(eco.elong.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(eco.elong.pgls)

#view coefficients
summary(eco.elong.pgls)
```

#### Activity period

```{r}
#pgls regressions testing for effect of adult activity period on each 3D shape metric (separately)

#prep data and tree----

#subset adults with activity period data
adult_phylo_activ<-filter(adult_phylo_means, !is.na(activity_period.adults))
table(adult_phylo_activ$activity_period.adults)

#trim tree to adults with activity period data
rownames(adult_phylo_activ)<-adult_phylo_activ$genus_species;
name.check(tree_orig,adult_phylo_activ)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.adult.activ;
#plot(tree.adult.activ)

#Remove excess data from species not found in tree
adult_phylo_activ<-adult_phylo_activ[ ! adult_phylo_activ$genus_species %in% overlap$data_not_tree, ]
adult_phylo_activ[] <- lapply(adult_phylo_activ, function(x) if(is.factor(x)) factor(x) else x)
adult_phylo_activ <-  adult_phylo_activ[tree.adult.activ$tip.label, ]

#make comparative object
adult.act.comp <- comparative.data(phy=tree.adult.activ, data=adult_phylo_activ, names.col=genus_species, vcv=TRUE, na.omit=FALSE, warn.dropped=TRUE)

#pgls for anisotropy----

#fit model
act.aniso.pgls <- pgls(mean_anisotropy.adults ~ activity_period.adults,
                       data = adult.act.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(act.aniso.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(act.aniso.pgls)

#view coefficients
summary(act.aniso.pgls)

#pgls for sphericity----

#fit model
act.sph.pgls <- pgls(mean_sphericity.adults ~ activity_period.adults,
                       data = adult.act.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(act.sph.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(act.sph.pgls)

#view coefficients
summary(act.sph.pgls)

#pgls for elongation----

#fit model
act.elong.pgls <- pgls(mean_elongation.adults ~ activity_period.adults,
                       data = adult.act.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(act.elong.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(act.elong.pgls)

#view coefficients
summary(act.elong.pgls)
```

### Procrustes MANOVA: Adult lens shape vs. ecology

#### Adult habitat

```{r}

#procD.pgls of adult lens shape (all 3 measures) by habitat
procD<-procD.pgls(adult_phylo_eco[,c("mean_anisotropy.adults","mean_elongation.adults","mean_sphericity.adults")]~adult_ecology.adults, tree.adult.eco, Cov = NULL, iter = 999,seed = NULL, int.first = FALSE, SS.type = NULL, effect.type = NULL, data = adult_phylo_eco, print.progress = TRUE)

summary(procD)
```

#### Activity period

```{r}
#procD.pgls of adult eye shape (all 3 measures) by activity period
procD<-procD.pgls(adult_phylo_activ[,c("mean_anisotropy.adults","mean_elongation.adults","mean_sphericity.adults")]~activity_period.adults, tree.adult.activ, Cov = NULL, iter = 999,seed = NULL, int.first = FALSE, SS.type = NULL, effect.type = NULL, data = adult_phylo_activ, print.progress = TRUE)

summary(procD)

```

### PGLS: Adult lens size vs. eye size + ecology

Here, we test whether lens size (relative to eye size) varies across habitats or activity periods among adult anurans (n=81 species) using PGLS regressions in geomorph.  

#### Habitat

```{r}

# Prep data and tree-----

#view distribution of data
table(adult_eye$adult_ecology)

# Make tree-trimmed dataset for habitat analysis of lens size 
adult_eye_eco <- filter(adult_eye, !is.na(adult_ecology)) %>% droplevels()
adult_eye_eco[] <- lapply(adult_eye_eco, function(x) if(is.factor(x)) factor(x) else x)
adult_eye_eco<-as.data.frame(adult_eye_eco)

#trim tree to adult data
rownames(adult_eye_eco)<-adult_eye_eco$genus_species;
name.check(tree_orig,adult_eye_eco)->overlap

#overlap
drop.tip(tree_orig, overlap$tree_not_data) -> tree_adult_eye_eco
#plot(tree_adult_eye_eco)

#Remove excess data from species not found in tree
adult_eye_eco<-adult_eye_eco[ ! adult_eye_eco$genus_species %in% overlap$data_not_tree, ]
adult_eye_eco[] <- lapply(adult_eye_eco, function(x) if(is.factor(x)) factor(x) else x)
adult_eye_eco <-  adult_eye_eco[tree_adult_eye_eco$tip.label, ]

#run PGLS using caper-----

# pgls in caper of lens ~ eye for plotting residuals---

#make comparative object
hab.eye.comp <- comparative.data(phy=tree_adult_eye_eco, data=adult_eye_eco, names.col=genus_species, vcv=TRUE, na.omit=FALSE, warn.dropped=TRUE)

#fit pgls model for lens vs. eye size
hab.eye.pgls <- pgls(mean.lens.diameter ~ mean.eye.diameter + adult_ecology,
                       data = hab.eye.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(hab.eye.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(hab.eye.pgls)

#view coefficients
summary(hab.eye.pgls)


## Alternate fit of PGLS using geomorph-----

#PGLS of lens size ~ eye size  + habitat
hab_eye_procD <- procD.pgls(mean.lens.diameter ~ mean.eye.diameter + adult_ecology, tree_adult_eye_eco, Cov = NULL, iter = 999, seed = NULL, int.first = FALSE, SS.type = NULL, effect.type = NULL, data = adult_eye_eco, print.progress = TRUE)

#model summary
summary(hab_eye_procD)

#pairwise comparisons
PairHabTest<-pairwise(hab_eye_procD, fit.null = NULL, adult_eye_eco$adult_ecology, covariate = NULL, print.progress = FALSE)
summary(PairHabTest)

```
#### Activity period

```{r}
# Prep data and tree-----

#view distribution of data
table(adult_eye$activity_period)

#Make tree-trimmed dataset for activity analysis of lens size 
adult_eye_activ<-filter(adult_eye, !is.na(activity_period)) %>% droplevels()
adult_eye_activ[] <- lapply(adult_eye_activ, function(x) if(is.factor(x)) factor(x) else x)
table(adult_eye_activ$activity_period)
adult_eye_activ<-as.data.frame(adult_eye_activ)

#trim tree to adult data
rownames(adult_eye_activ)<-adult_eye_activ$genus_species;
name.check(tree_orig,adult_eye_activ)->overlap

#overlap
drop.tip(tree_orig, overlap$tree_not_data)->tree.eye.activ;
#plot(tree.eye.activ)

#Remove excess data from species not found in tree
adult_eye_activ<-adult_eye_activ[ ! adult_eye_activ$genus_species %in% overlap$data_not_tree, ]
adult_eye_activ[] <- lapply(adult_eye_activ, function(x) if(is.factor(x)) factor(x) else x)
adult_eye_activ <-  adult_eye_activ[tree.eye.activ$tip.label, ]

#different factor order for contrasts
adult_eye_activ$activity_period <- factor(adult_eye_activ$activity_period, levels = c("nocturnal", "diurnal", "both"))

#run PGLS using caper-----

# pgls in caper of lens ~ eye for plotting residuals---

#make comparative object
act.eye.comp <- comparative.data(phy=tree.eye.activ, data=adult_eye_activ, names.col=genus_species, vcv=TRUE, na.omit=FALSE, warn.dropped=TRUE)

#fit pgls model for lens vs. eye size
act.eye.pgls <- pgls(mean.lens.diameter ~ mean.eye.diameter + activity_period,
                       data = act.eye.comp, 
                       lambda="ML")

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(act.eye.pgls)
par(mfrow = c(1, 1))

#view main effects
anova(act.eye.pgls)

#view coefficients
summary(act.eye.pgls)

#run alternate PGLS in geomorph-----

#PGLS of lens size ~  eye size + activity period
act_eye_procD <- procD.pgls(mean.lens.diameter~mean.eye.diameter + activity_period, tree.eye.activ, Cov = NULL, iter = 999,seed = NULL, int.first = FALSE, SS.type = NULL, effect.type = NULL, data = adult_eye_activ, print.progress = TRUE)

#model summary
summary(act_eye_procD)
  
#pairwise comparisons
PairActivTest<-pairwise(act_eye_procD, fit.null = NULL, adult_eye_activ$activity_period, covariate = NULL, print.progress = FALSE)
summary(PairActivTest)
```

# Figures

## Figure 2 : Comparison of tadpole and adult lens shapes

Panel A - PCA of tadpoles vs adults across all specimens, Panel B - Violin plots of species means for 3 shape metrics by tadpole and adult life stages

```{r Figure 2}

#### Panel A: tadpole and adult lens shape PCA ####

#put PCA results into dataframe format
df_pca <- as.data.frame(lens.pca$x) 

#add a group column by breaking apart the rownames from the original dataframe
df_pca$group <- sapply(strsplit(as.character(row.names(species_stage_means)), "_"),  "[", 1)

#alternate attempt to get life stage to merge with df_pca
## is pca dataframe in same order as species_stage_mean dataframe?? if not, this is not correct.
df_pca$group <- species_stage_means$life_stage

#extract loadings of the variables
pca_loadings <- data.frame(Variables = rownames(lens.pca$rotation), lens.pca$rotation)

#make ggplot of results  
plot_pca <- ggplot(df_pca, 
                   aes(x = PC1, y = PC2)) +
  geom_segment(data = pca_loadings, aes(x = 0, y = 0, xend = (PC1*4), # adds arrows - eigenvectors
                                        yend = (PC2*4)), arrow = arrow(length = unit(1/2, "picas")),
               color = "black") +
  geom_point(aes(fill=group), pch = 21, alpha = 0.8) + 
  scale_fill_manual(values=c("black","white"), name = "Life stage") +
  #annotate("text", x = (pca_loadings$PC1*4), y = (pca_loadings$PC2*4), label = pca_loadings$Variables) + #adds eigenvector labels. Not using in this case because too hard to position
  stat_ellipse(data = filter(df_pca, group == "tadpole"), aes(x=PC1, y=PC2), type = "norm", linetype = "dotted") + # adds elliptical cluster for tadpole group
  stat_ellipse(data = filter(df_pca, group == "adult"), aes(x=PC1, y=PC2), type = "norm") + # adds elliptical cluster for adult group
  xlab("PC 1 (53%)") + 
  ylab("PC 2 (33%)") +
  theme_minimal() +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent"))

plot_pca

#note for the arrows, the one pointing left is for anisotropy, up is for flatness, to the right is for sphericity. 

#### Panel B: violin of 3 shape metrics by tadpole and adult ####

#put specimen data into long format for plotting
value <- species_stage_means$mean_anisotropy
stage <- species_stage_means$life_stage
metric <- "anisotropy"
shape1 <- data.frame(metric, value, stage)

value <- species_stage_means$mean_sphericity
stage <- species_stage_means$life_stage
metric <- "sphericity"
shape3 <- data.frame(metric, value, stage)

value <- species_stage_means$mean_elongation
stage <- species_stage_means$life_stage
metric <- "elongation"
shape4 <- data.frame(metric, value, stage)

shape.final <- rbind(shape1, shape3, shape4)

# extract artificial objects from raw dataset
objects <- lens_data %>%
  filter(life_stage == "artificial")

# make same long form dataset for objects
value <- objects$anisotropy
type <- objects$specimen_id
stage<- objects$life_stage
metric <- "anisotropy"
shape1 <- data.frame(metric, value, type, stage)

value <- objects$sphericity
type <- objects$specimen_id
metric <- "sphericity"
shape3 <- data.frame(metric, value, type, stage)

value <- objects$elongation
type <- objects$specimen_id
metric <- "elongation"
shape4 <- data.frame(metric, value, type, stage)

object.final <- rbind(shape1, shape3, shape4)

#make plot
shape.plot <- shape.final %>%
  mutate(metric = fct_relevel(metric, "anisotropy", "sphericity", "elongation")) %>%
  ggplot(aes(x = metric, y = value, fill = stage)) +
  scale_fill_manual(values=c("gray42", "white")) +
  geom_violin(alpha=0.6, trim = T, width = 1.2, position = position_dodge(1)) +
  geom_point(aes(fill = stage), pch = 19, alpha = 0.4, size = 0.2,  position=position_jitterdodge(dodge.width=1, jitter.width = 0.4)) +
  geom_boxplot(width = 0.15, position = position_dodge(1), alpha=0.1) + #controls boxes
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) + #controls background
  xlab("Shape Metric") +
  ylab("Value")
  #geom_jitter(data = object.final, aes(x = metric, y = value, shape = type), position = position_jitter(0), size=3) #this adds reference shapes

shape.plot 

#make 3-panel plot for tad/adult shapes

#anisotropy plot
anis.plot <- shape.final %>%
  filter(metric == "anisotropy") %>%
  ggplot(aes(y = value, x = stage)) +
  scale_fill_manual(values=c("black", "white")) +
  geom_point(aes(fill = stage), pch = 21, alpha = 0.6, size = .7,  position=position_jitterdodge(dodge.width=1, jitter.width = 1)) +
  geom_violin(alpha=0.1, trim = T, width = 1, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), alpha=0.1) + #controls boxes
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = 'none') + #controls background
  xlab("") +
  ylab("Anisotropy value") +
  ylim(c(0,0.5)) +
  #add line for perfect sphere
  geom_hline(yintercept=0, linetype = 'dashed') + #add line for lens replica
  geom_hline(yintercept = specimen_means$mean_anisotropy[specimen_means$specimen_id == "Lens_replica"], linetype = 'dotted') 


#sphericity plot
spher.plot <- shape.final %>%
  filter(metric == "sphericity") %>%
 ggplot(aes(y = value, x = stage)) +
  scale_fill_manual(values=c("black", "white")) +
  geom_point(aes(fill = stage), pch = 21, alpha = 0.6, size = .7,  position=position_jitterdodge(dodge.width=1, jitter.width = 1)) +
  geom_violin(alpha=0.1, trim = T, width = 1, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), alpha=0.1) + #controls boxes
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = 'none') + #controls background
  xlab("") +
  ylab("Sphericity value") +
  ylim(c(0.75,1)) +
  #add line for perfect sphere
   geom_hline(yintercept=1, linetype = 'dashed') + #add line for lens replica
  geom_hline(yintercept = specimen_means$mean_sphericity[specimen_means$specimen_id == "Lens_replica"], linetype = 'dotted') 

#elongation value
elong.plot <- shape.final %>%
  filter(metric == "elongation") %>%
  ggplot(aes(y = value, x = stage)) +
  scale_fill_manual(values=c("black", "white")) +
  geom_point(aes(fill = stage), pch = 21, alpha = 0.6, size = .7,  position=position_jitterdodge(dodge.width=1, jitter.width = 1)) +
  geom_violin(alpha=0.1, trim = T, width = 1, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), alpha=0.1) + #controls boxes
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = 'none') + #controls background
  xlab("") +
  ylab("Elongation value") +
  ylim(c(0.75,1)) +
  #add line for perfect sphere
  geom_hline(aes(yintercept=1, linetype = "Sphere")) +
  geom_hline(aes(yintercept = specimen_means$mean_elongation[specimen_means$specimen_id == "Lens_replica"], linetype = "Lens replica")) + #add line for lens replica
  scale_linetype_manual(name = "Reference shapes", values = c('dashed','dotted'))


# Construct figure -------

#label pca panel
plot_top <- plot_grid(plot_pca,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 1) #number of rows in grids


# arrange 3 shape panels together
plots_bottom <- plot_grid(anis.plot, spher.plot, elong.plot,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("B", "C", "D"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#show figure together
grid.arrange(plot_top, plots_bottom, ncol = 1, nrow = 2)

#export figure
pdf(file = "Figures/Fig2.pdf", width = 6,  height = 8)
grid.arrange(plot_top, plots_bottom, ncol = 1, nrow = 2)
dev.off()
```


## Figure 3A : Phylogeny with PC scores. 

Species names are coloured by microhabitat. Circles and dotted lines added in illustrator

```{r Figure 3, fig.height = 12, fig.width = 6}

# Extracting PC scores
PC1_tad<-phylo_pca_means$mean_PC1.tads
names(PC1_tad)<-phylo_pca_means$genus_species
PC1_tad<-PC1_tad[tree.pruned$tip.label]

PC1_adult<-phylo_pca_means$mean_PC1.adults
names(PC1_adult)<-phylo_pca_means$genus_species
PC1_adult<-PC1_adult[tree.pruned$tip.label]


# Plot tree
plot(tree.pruned, show.tip.label= T, font=3, cex=0.5, label.offset = 1.5, edge.width=3)
segments(340 + (PC1_tad*40), 1:nrow(phylo_pca_means), 340 + (PC1_adult*10), 1:nrow(phylo_pca_means), col="grey90", lwd=5)
segments(340 + (PC1_tad*40), 1:nrow(phylo_pca_means), 340 + (PC1_tad*40), 1:nrow(phylo_pca_means), col="grey", lwd=5)
segments(340 + (PC1_adult*10), 1:nrow(phylo_pca_means), 340 + (PC1_adult*10), 1:nrow(phylo_pca_means), col="black", lwd=5)

lastPP<-get("last_plot.phylo",env=.PlotPhyloEnv)

SpEcology<-phylo_pca_means$adult_ecology.adults
SemiEcoColr<-c("#0072B2","#D55E00","#E69F00","#009E73","#56B4E9","#CC79A7","grey")
names(SemiEcoColr) <- levels(SpEcology)
SemiEcoColr<- SemiEcoColr[match(SpEcology, names(SemiEcoColr))] # col.gp must NOT be a factor
names(SemiEcoColr)<-phylo_pca_means$genus_species
SemiEcoColr<-SemiEcoColr[tree.pruned$tip.label]

#Print graph
plot(tree.pruned, show.tip.label= F, font=3, cex=0.5, label.offset = 1.5, edge.width=3, x.lim=c(0,700))
par(fg="black")
tt<-gsub("_"," ",tree.pruned$tip.label)
text(lastPP$xx[1:length(tt)],lastPP$yy[1:length(tt)], tt,cex=0.5,col=SemiEcoColr, pos=4, offset=0.1, font=3)
segments(550 + (PC1_tad*50), 1:nrow(phylo_pca_means), 550 + (PC1_adult*50), 1:nrow(phylo_pca_means), col="grey90", lwd=5)
segments(550 + (PC1_tad*50), 1:nrow(phylo_pca_means), 550 + (PC1_tad*50), 1:nrow(phylo_pca_means), col="grey", lwd=5)
segments(550 + (PC1_adult*50), 1:nrow(phylo_pca_means), 550 + (PC1_adult*50), 1:nrow(phylo_pca_means), col="black", lwd=5)

#Export figure
pdf(file = "Figures/Fig3a.pdf", width = 6,  height = 12)
plot(tree.pruned, show.tip.label= F, font=3, cex=0.5, label.offset = 1.5, edge.width=3, x.lim=c(0,700))
par(fg="black")
tt<-gsub("_"," ",tree.pruned$tip.label)
text(lastPP$xx[1:length(tt)],lastPP$yy[1:length(tt)], tt,cex=0.5, col=SemiEcoColr, pos=4, offset=0.1, font=3)
segments(550 + (PC1_tad*50), 1:nrow(phylo_pca_means), 550 + (PC1_adult*50), 1:nrow(phylo_pca_means), col="grey90", lwd=5)
segments(550 + (PC1_tad*50), 1:nrow(phylo_pca_means), 550 + (PC1_tad*50), 1:nrow(phylo_pca_means), col="grey", lwd=5)
segments(550 + (PC1_adult*50), 1:nrow(phylo_pca_means), 550 + (PC1_adult*50), 1:nrow(phylo_pca_means), col="black", lwd=5)
dev.off()
```


## Figure 3BC & S4: Species with matched tadpole and adult lens shape data across adult habitats. 

```{r Figure 4}

# Prep data for tadpole and adult lens shape within species --- 

#put data in long format

#tadpole data
tadData <- data.frame(species = both_phylo_means$genus_species,
                      anisotropy = both_phylo_means$mean_anisotropy.tads,
                      sphericity = both_phylo_means$mean_sphericity.tads,
                      elongation = both_phylo_means$mean_elongation.tads,
                      eco = both_phylo_means$adult_ecology.tads,
                      stage = "tadpole")

#adult data
adultData <- data.frame(species = both_phylo_means$genus_species,
                        anisotropy = both_phylo_means$mean_anisotropy.adults,
                        sphericity = both_phylo_means$mean_sphericity.adults,
                        elongation = both_phylo_means$mean_elongation.adults,
                        eco = both_phylo_means$adult_ecology.adults,
                        stage = "adult")

#combine datasets
matchData <- rbind(tadData, adultData)
matchData$stage <- factor(matchData$stage, levels = c("tadpole", "adult"))
matchData$eco <- factor(matchData$eco, levels = c("aquatic","fossorial","subfossorial","semi-aquatic","ground-dwelling","scansorial"))

#add column binning adults into "aquatic" or "terrestrial"
matchData$hab <- ifelse(matchData$eco=="aquatic", "aquatic", "terrestrial")

#make column that codes for both tadpole and adult habitat (for coloring)
matchData$hab2 <- ifelse(matchData$stage=="tadpole", "aquatic", matchData$hab)

#make column for faceting/labels based on adult habitat
matchData$lab <- ifelse(matchData$eco=="aquatic", "aquatic adult", "terrestrial adult")

# Make Figure 4 ------

#define habitat colors
col_hab_binary <- c("aquatic" = "#0072B2",
                    "terrestrial" = "#4d3208")

#define life stage points
shape_stage <- c("tadpole" = 1,
                 "adult" = 19)

#plot matched data separated by adult habitats

#anisotropy
an.paired.plot2 <- ggplot(matchData, aes(x = stage, y = anisotropy, fill = hab2)) +
  scale_fill_manual(values = col_hab_binary, name = "Habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_line(aes(group = species, col = "black"), alpha = 0.9) +
  scale_color_manual(values = col_hab_binary, name = "Habitat") +
  geom_violin(alpha=0.5, trim = T, width = .8, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), fill="white", outlier.alpha = 0) +
  geom_point(size = 2, alpha = 0.8, aes(shape = stage)) + 
  labs(x = "Life stage", y = "Anisotropy") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none") +
  facet_wrap(~lab, nrow = 1)

#sphericity
sp.paired.plot2 <- ggplot(matchData, aes(x = stage, y = sphericity, fill = hab2)) +
  scale_fill_manual(values = col_hab_binary, name = "Habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_line(aes(group = species, col = "black"), alpha = 0.9) +
  scale_color_manual(values = col_hab_binary, name = "Habitat") +
  geom_violin(alpha=0.5, trim = T, width = .8, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), fill="white", outlier.alpha = 0) +
  geom_point(size = 2, alpha = 0.8, aes(shape = stage)) + 
  labs(x = "Life stage", y = "Sphericity") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none") +
  facet_wrap(~lab, nrow = 1)

#elongation
el.paired.plot2 <- ggplot(matchData, aes(x = stage, y = elongation, fill = hab2)) +
  scale_fill_manual(values = col_hab_binary, name = "Habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_line(aes(group = species, col = "black"), alpha = 0.9) +
  scale_color_manual(values = col_hab_binary, name = "Habitat") +
  geom_violin(alpha=0.5, trim = T, width = .8, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), fill="white", outlier.alpha = 0) +
  geom_point(size = 2, alpha = 0.8, aes(shape = stage)) + 
  labs(x = "Life stage", y = "Elongation") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none") +
  facet_wrap(~lab, nrow = 1)

# Construct Figure 3BC -------

fig.b <- an.paired.plot2 +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank()) 

fig.c <- sp.paired.plot2 +
  theme(strip.background = element_blank(), strip.text.x = element_blank()) 

plots <- plot_grid(fig.b, fig.c,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("B", "C"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 2) #number of rows in grids

#print figure
plots

#export figure
pdf(file = "Figures/Fig3bc.pdf", width = 3,  height = 8)
plots
dev.off()


# Make supplemental figure -----

#define a colorblind-friendly vector of colors for adult habitat
col_hab <- c("aquatic" = "#0072B2",
              "fossorial" = "#D55E00",
              "ground-dwelling" = "#E69F00",
              "scansorial" = "#009E73",
              "semi-aquatic" = "#56B4E9",
              "subfossorial" = "#CC79A7")

shape_stage <- c("tadpole" = 1,
                 "adult" = 19)

#plot matched data for anisotropy
ggplot(matchData, aes(x = stage, y = anisotropy, col = eco)) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_point(size = 3, alpha = 0.8, aes(shape = stage)) + 
  geom_line(aes(group = species, col = eco)) +
  labs(x = "Life stage", y = "Anisotropy") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
  
#plot matched data separated by adult habitats

#anisotropy
an.paired.plot <- ggplot(matchData, aes(x = stage, y = anisotropy, fill = eco)) +
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_line(aes(group = species, col = eco), alpha = 1) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  geom_violin(alpha=0.5, trim = T, width = .8, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), fill="white", outlier.alpha = 0) +
  geom_point(size = 2, alpha = 0.9, aes(shape = stage)) + 
  labs(x = "Life stage", y = "Anisotropy") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none") +
  facet_wrap(~eco, nrow = 1)
  
#sphericity
sp.paired.plot <- ggplot(matchData, aes(x = stage, y = sphericity, fill = eco)) +
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_line(aes(group = species, col = eco), alpha = 1) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  geom_violin(alpha=0.5, trim = T, width = .8, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), fill="white", outlier.alpha = 0) +
  geom_point(size = 2, alpha = 0.9, aes(shape = stage)) + 
  labs(x = "Life stage", y = "Sphericity") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none") +
  facet_wrap(~eco, nrow = 1)

#elongation
el.paired.plot <- ggplot(matchData, aes(x = stage, y = elongation, fill = eco)) +
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  scale_shape_manual(values = shape_stage, name = "Life stage") +
  geom_line(aes(group = species, col = eco), alpha = 1) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  geom_violin(alpha=0.5, trim = T, width = .8, position = position_dodge(1)) + 
  geom_boxplot(width = 0.2, position = position_dodge(1), fill="white", outlier.alpha = 0) +
  geom_point(size = 2, alpha = 0.9, aes(shape = stage)) + 
  labs(x = "Life stage", y = "Elongation") + 
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none") +
  facet_wrap(~eco, nrow = 1)


# Construct supplemental figure -------

fig.a <- an.paired.plot +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank()) 

fig.b <- sp.paired.plot +
  theme(strip.background = element_blank(), strip.text.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank()) 

fig.c <- el.paired.plot +
  theme(strip.background = element_blank(), strip.text.x = element_blank()) 


plots <- plot_grid(fig.a, fig.b, fig.c,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A", "B", "C"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 3) #number of rows in grids

#print figure
plots

#export figure
pdf(file = "Figures/FigS4.pdf", width = 8,  height = 11)
plots
dev.off()
```


## Figure 4: Adult lens shape by ecology

Part 1: PCA centroids for adult lens shape vs ecology (habitat and activity period)

```{r Figure 4ab}

#adult eye measures vs habitat 
adult_phylo_eco<-filter(adults_mean, adult_ecology != "unknown")
#table(adult_phylo_eco$adult_ecology)

#capitalize genus 
str_sub(adult_phylo_eco$genus_species, 1, 1) <- str_sub(adult_phylo_eco$genus_species, 1, 1) %>% str_to_upper()

#add synonym and substitutions for phylogeny into dataframe (lens_species column)
adult_phylo_eco[adult_phylo_eco$genus_species=="Hypsiboas_geographica", "genus_species"] <- "Hypsiboas_geographicus"
adult_phylo_eco[adult_phylo_eco$genus_species=="Chiasmocleis_hudsoni", "genus_species"] <- "Syncope_hudsoni"
adult_phylo_eco[adult_phylo_eco$genus_species=="Rhombophryne_nilevina", "genus_species"] <- "Rhombophryne_alluaudi"

#trim tree to adult data
rownames(adult_phylo_eco)<-adult_phylo_eco$genus_species;
name.check(tree_orig,adult_phylo_eco)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.adult.eco;
#plot(tree.adult.eco)
#Remove excess data from species not found in tree
adult_phylo_eco<-adult_phylo_eco[ ! adult_phylo_eco$genus_species %in% overlap$data_not_tree, ]
adult_phylo_eco[] <- lapply(adult_phylo_eco, function(x) if(is.factor(x)) factor(x) else x)
rownames(adult_phylo_eco)<-adult_phylo_eco$genus_species;
adult_phylo_eco <-  adult_phylo_eco[tree.adult.eco$tip.label, ]

# adult eye data with activity pattern
adult_phylo_activ<-filter(adults_mean, activity_period != "unknown")
table(adult_phylo_activ$activity_period)

#capitalize genus 
str_sub(adult_phylo_activ$genus_species, 1, 1) <- str_sub(adult_phylo_activ$genus_species, 1, 1) %>% str_to_upper()

#add synonym and substitutions for phylogeny into dataframe (lens_species column)
adult_phylo_activ[adult_phylo_activ$genus_species=="Hypsiboas_geographica", "genus_species"] <- "Hypsiboas_geographicus"
adult_phylo_activ[adult_phylo_activ$genus_species=="Chiasmocleis_hudsoni", "genus_species"] <- "Syncope_hudsoni"
adult_phylo_activ[adult_phylo_activ$genus_species=="Rhombophryne_nilevina", "genus_species"] <- "Rhombophryne_alluaudi"

#trim tree to adult data
rownames(adult_phylo_activ)<-adult_phylo_activ$genus_species;
name.check(tree_orig,adult_phylo_activ)->overlap
#overlap
drop.tip(tree_orig,overlap$tree_not_data)->tree.adult.activ;
#plot(tree.adult.activ)
#Remove excess data from species not found in tree
adult_phylo_activ<-adult_phylo_activ[ ! adult_phylo_activ$genus_species %in% overlap$data_not_tree, ]
adult_phylo_activ[] <- lapply(adult_phylo_activ, function(x) if(is.factor(x)) factor(x) else x)
rownames(adult_phylo_activ)<-adult_phylo_activ$genus_species;
adult_phylo_activ <-  adult_phylo_activ[tree.adult.activ$tip.label, ]

#### Habitat ####
eco.pca <- prcomp(adult_phylo_eco[,c("mean_anisotropy","mean_elongation","mean_sphericity")], center = TRUE, scale. = TRUE)

Eco <- adult_phylo_eco$adult_ecology
names(Eco)<-row.names(adult_phylo_eco)
EcoColr<-c("#0072B2","#D55E00","#E69F00","#009E73","#56B4E9","#CC79A7","white")
names(EcoColr) <- levels(Eco)
EcoColr<- EcoColr[match(Eco, names(EcoColr))] # col.gp must NOT be a factor

ecoPlot<-pca2d(eco.pca$x, group= Eco, shape = 16 , col =EcoColr, show.centroids = TRUE, radius =1.5,show.labels=F)

legend("bottomright", ecoPlot$groups, col=ecoPlot$colors, pch=ecoPlot$pch, box.lty=0)

#### Activity Pattern ####
activ.pca <- prcomp(adult_phylo_activ[,c("mean_anisotropy","mean_elongation","mean_sphericity")], center = TRUE, scale. = TRUE)

activ <- adult_phylo_activ$activity_period
names(activ)<-row.names(adult_phylo_activ)
activColr<-c("#CD1076","#FFB90F","#8A2BE2")
#activColr<-c(values=(magma(3, direction = -1)))
names(activColr) <- levels(activ)
activColr<- activColr[match(activ, names(activColr))] # col.gp must NOT be a factor

activPlot<-pca2d(activ.pca$x, group= activ, shape = 16 , col =activColr, show.centroids = TRUE, radius =1.5,show.labels=F)

legend("bottomright", activPlot$groups, col=activPlot$colors, pch=activPlot$pch, box.lty=0)

#export panels A & B-----

#print graph
pdf(file = "Figures/Fig4AB.pdf", width = 13,  height = 5, useDingbats=FALSE)
par(mfrow=c(1,2))

ecoPlot<-pca2d(eco.pca$x, group= Eco, shape = 16 , col =EcoColr, show.centroids = TRUE, radius =1.5,show.labels=F)
legend("bottomright", ecoPlot$groups, col=ecoPlot$colors, pch=ecoPlot$pch, box.lty=0)

activPlot<-pca2d(activ.pca$x, group= activ, shape = 16 , col =activColr, show.centroids = TRUE, radius =1.5,show.labels=F)
legend("bottomright", c("diurnal", "nocturnal", "neither"), col=c("#FFB90F", "#8A2BE2", "#CD1076"), pch=16, box.lty=0)

dev.off()
```

Part 2: Violin plots of adult lens shape across ecology (habitat and activity period)

```{r Figure 4cdef}

#create vector of colors for activity period
col_act <- c("both" = "deeppink3",
             "diurnal" = "darkgoldenrod1", 
             "nocturnal" = "blueviolet")

# Adult habitat ------

#anisotropy
anis_habs <- ggplot(adult_phylo_eco, aes(x=adult_ecology, y=mean_anisotropy, fill=adult_ecology)) + 
  geom_violin(trim=FALSE, alpha = 0.7)+
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  labs(title=NULL,x="Habitat", y = "Anisotropy value")+
  geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  ylim(c(0, 0.6))
 
#sphericity
sph_habs <- ggplot(adult_phylo_eco, aes(x=adult_ecology, y=mean_sphericity, fill=adult_ecology)) + 
  geom_violin(trim=FALSE, alpha = 0.7)+
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  labs(title=NULL,x="Habitat", y = "Sphericity value")+
  geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  ylim(c(0.85, 1))

#elongation
elong_habs <- ggplot(adult_phylo_eco, aes(x=adult_ecology, y=mean_elongation, fill=adult_ecology)) + 
  geom_violin(trim=FALSE, alpha = 0.7)+
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  labs(title=NULL,x="Habitat", y = "Elongation value")+
  geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic()+
  ylim(c(0.8, 1))

# Adult activity period ------
#anisotropy
anis_act <- ggplot(adult_phylo_activ, aes(x=activity_period, y=mean_anisotropy, fill=activity_period)) + 
  geom_violin(trim=FALSE, alpha = 0.5)+
  scale_fill_manual(values = col_act, name = "Adult activity period") +
  labs(title=NULL,x="Activity Period", y = "Anisotropy value")+
  geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  ylim(c(0, 0.6))
 
#sphericity
sph_act <- ggplot(adult_phylo_activ, aes(x=activity_period, y=mean_sphericity, fill=activity_period)) + 
  geom_violin(trim=FALSE, alpha = 0.5)+
  scale_fill_manual(values = col_act, name = "Adult activity period") +
  labs(title=NULL,x="Activity Period", y = "Sphericity value")+
  geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic()+
  ylim(c(0.85, 1))

#elongation
elong_act <- ggplot(adult_phylo_activ, aes(x=activity_period, y=mean_elongation, fill=activity_period)) + 
  geom_violin(trim=FALSE, alpha = 0.5)+
  scale_fill_manual(values = col_act, name = "Adult activity period") +
  labs(title=NULL,x="Activity Period", y = "Elongation value")+
  geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  ylim(c(0.8, 1))

# Construct main figure -----

#make panels without lengends
fig.c <- anis_habs + 
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        text = element_text(size = 16)) +
  ylab("Anisotropy") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = specimen_means$mean_anisotropy[specimen_means$specimen_id == "Lens_replica"], linetype = "dotted") +
  scale_x_discrete(breaks = c("aquatic","fossorial","semi-aquatic", "subfossorial","ground-dwelling","scansorial"),
                   limits = c("aquatic","fossorial","semi-aquatic", "subfossorial","ground-dwelling","scansorial"),
                   labels = c("aq.","foss.","semiaq.","subfoss.", "ground", "scans.") )

fig.d <- anis_act + 
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        text = element_text(size = 16)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = specimen_means$mean_anisotropy[specimen_means$specimen_id == "Lens_replica"], linetype = "dotted") +
  scale_x_discrete(breaks = c("diurnal","nocturnal","both"),
                   limits = c("diurnal","nocturnal","both"),
                   labels = c("diurnal", "nocturnal", "other"))

fig.e <- sph_habs + 
  theme(legend.position = "none",
        text = element_text(size = 16)) +
  xlab("Habit") +
  ylab("Sphericity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_hline(yintercept = specimen_means$mean_sphericity[specimen_means$specimen_id == "Lens_replica"], linetype = "dotted") +
  scale_x_discrete(breaks = c("aquatic","fossorial","semi-aquatic", "subfossorial","ground-dwelling","scansorial"),
                   limits = c("aquatic","fossorial","semi-aquatic", "subfossorial","ground-dwelling","scansorial"),
                   labels = c("aq.","foss.","semiaq.","subfoss.", "ground", "scans.") )
  
fig.f <- sph_act + 
  theme(legend.position = "none",
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        text = element_text(size = 16)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_hline(yintercept = specimen_means$mean_sphericity[specimen_means$specimen_id == "Lens_replica"], linetype = "dotted") +
  scale_x_discrete(breaks = c("diurnal","nocturnal","both"),
                   limits = c("diurnal","nocturnal","both"),
                   labels = c("diur.", "noct.", "neith."))

#make panels just with anisotropy and sphericity for habitat and activity period
plots <- plot_grid(fig.c, fig.d, fig.e, fig.f,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("C", "D", "E", "F"), #panel labels for figure
           hjust = 0, #adjustment for panel labels
           nrow = 2,
           rel_widths = c(1.8,1))


#print figure
plots

#export figure
pdf(file = "Figures/Fig4cdef.pdf", width = 8,  height = 8)
plots
dev.off()

# Supplemental figure -----

#make panels with elongation for habitat and activity period
plots <- plot_grid(elong_habs + theme(legend.position = "none"), 
                   elong_act + theme(legend.position = "none"),
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A", "B"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 1,
           rel_widths = c(1.8,1))

#print figure
plots

#export figure
pdf(file = "Figures/Fig-supp-adultelong.pdf", width = 10,  height = 4)
plots
dev.off()
```


## Figure 5: Violins of relative lens size by microhabitat (Panel A) and activity pattern (Panel B)

```{r Figure 5}

#### Habitat ####

# pgls in caper of lens ~ eye for plotting residuals---

#fit pgls model for lens vs. eye size
hab.lenseye.pgls <- pgls(mean.lens.diameter ~ mean.eye.diameter,
                       data = hab.eye.comp, 
                       lambda="ML")


#extract pgls residuals 
pglsres.habeye <- residuals(hab.lenseye.pgls) 

#name residuals
colnames(pglsres.habeye) <- "pglsres.habeye" 

#merge residuals with original data by rowname
adult_eye_eco2 <- merge(adult_eye_eco, pglsres.habeye, by = "row.names")

#plot with caper pgls residuals
gg_eco <- ggplot(adult_eye_eco2, aes(x=adult_ecology, y=pglsres.habeye, fill=adult_ecology)) + 
  geom_violin(trim=FALSE, alpha = 0.7)+
  scale_fill_manual(values = col_hab, name = "Adult habitat") +
  labs(title=NULL,x="Habitat", y = "Residual Lens Size")+
  geom_boxplot(width=0.15, fill="white")+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic()  +
  ylim(c(-1.6, 1.2))

#### Activity Pattern ####

# pgls in caper of lens ~ eye for plotting residuals---

#fit pgls model for lens vs. eye size
act.lenseye.pgls <- pgls(mean.lens.diameter ~ mean.eye.diameter,
                       data = act.eye.comp, 
                       lambda="ML")

#extract pgls residuals 
pglsres.acteye <- residuals(act.lenseye.pgls) 

#name residuals
colnames(pglsres.acteye) <- "pglsres.acteye" 

#merge residuals with original data by rowname
adult_eye_activ2 <- merge(adult_eye_activ, pglsres.acteye, by = "row.names")

#make plot of caper pgls resudals across activity periods
gg_activ <- ggplot(adult_eye_activ2, aes(x=activity_period, y=pglsres.acteye, fill=activity_period)) + 
  geom_violin(trim=FALSE, alpha = 0.5)+
  scale_fill_manual(values = col_act, name = "Adult activity period") +
  labs(title=NULL,x="Activity Period", y = "Residual Lens Size")+
  geom_boxplot(width=0.15, fill="white")+
  geom_jitter(shape = 19, size = 1, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  ylim(c(-1.6, 1.2))

gg_activ 

#Construct figure----

fig.a <- gg_eco + 
  theme(legend.position = "none", 
        text = element_text(size = 16)) +
  scale_x_discrete(breaks = c("aquatic","fossorial","semi-aquatic", "subfossorial","ground-dwelling","scansorial"),
                   limits = c("aquatic","fossorial","semi-aquatic", "subfossorial","ground-dwelling","scansorial"),
                   labels = c("aq.","foss.","semiaq.","subfoss.", "ground", "scans.") ) +
  xlab("Habit")
  
  
fig.b <- gg_activ + 
  theme(legend.position = "none", 
        text = element_text(size = 16)) +
  scale_x_discrete(breaks = c("diurnal","nocturnal","both"),
                 limits = c("diurnal","nocturnal","both"),
                 labels = c("diur.", "noct.", "neith."))

plots <- plot_grid(fig.a, fig.b,
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A", "B"), #panel labels for figure
           hjust = -.1, #adjustment for panel labels
           nrow = 1,
           rel_widths = c(1.8,1))

plots

#print graph
pdf(file = "Figures/Fig5.pdf", width = 8,  height = 4)
plots
dev.off()

```
